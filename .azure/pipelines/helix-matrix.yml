# We only want to run full helix matrix on master
trigger:
  batch: true
  branches:
    include:
    - master

variables:
- ${{ if ne(variables['System.TeamProject'], 'internal') }}:
  - name: _UseHelixOpenQueues
    value: 'true'
- ${{ if eq(variables['System.TeamProject'], 'internal') }}:
  - group: DotNet-HelixApi-Access
  - name: _UseHelixOpenQueues
    value: 'false'

jobs:
- template: jobs/default-build.yml
  parameters:
    jobName: Helix_matrix_x64
    jobDisplayName: 'Tests: Helix x64'
    agentOs: Windows
    timeoutInMinutes: 240
    steps:
    # Build the shared framework
    - script: ./build.cmd -ci -all -pack -arch x64 /p:ASPNETCORE_TEST_LOG_DIR=artifacts/log /bl:artifacts/log/helix.build.x64.binlog
      displayName: Build shared fx
    - script: .\restore.cmd -ci /p:BuildInteropProjects=true
      displayName: Restore interop projects
    - script: .\build.cmd -ci -NoRestore -test -noBuildJava -all -projects eng\helix\helix.proj /p:IsHelixDaily=true /p:IsRequiredCheck=true /p:IsHelixJob=true /p:BuildInteropProjects=true /p:RunTemplateTests=true /p:ASPNETCORE_TEST_LOG_DIR=artifacts/log -bl
      displayName: Run build.cmd helix target
      env:
        HelixApiAccessToken: $(HelixApiAccessToken) # Needed for internal queues
        SYSTEM_ACCESSTOKEN: $(System.AccessToken) # We need to set this env var to publish helix results to Azure Dev Ops
    artifacts:
    - name: Helix_logs
      path: artifacts/log/
      publishOnError: true
      
  # Helix ARM64
  - template: jobs/default-build.yml
    parameters:
      jobName: Helix_arm64_daily
      jobDisplayName: "Tests: Helix ARM64 Daily"
      agentOs: Linux
      timeoutInMinutes: 180
      steps:
      # Build the shared framework
      - script: ./restore.sh -ci -nobl
        displayName: Restore
      - script: ./build.sh -ci --nobl --arch arm64 -test --no-build-nodejs --all -projects $(Build.SourcesDirectory)/eng/helix/helix.proj /p:IsHelixJob=true /p:IsHelixDaily=true /p:ASPNETCORE_TEST_LOG_DIR=artifacts/log
        displayName: Run build.sh helix arm64 target
        env:
          HelixApiAccessToken: $(HelixApiAccessToken) # Needed for internal queues
          SYSTEM_ACCESSTOKEN: $(System.AccessToken) # We need to set this env var to publish helix results to Azure Dev Ops
      installNodeJs: false
      artifacts:
      - name: Helix_arm64_logs
        path: artifacts/log/
        publishOnError: true
        includeForks: true      
